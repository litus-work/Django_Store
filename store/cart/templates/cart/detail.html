{% extends "base.html" %}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ ¬∑ GadgetShop{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-6">–ö–æ—Ä–∑–∏–Ω–∞</h2>

{% if cart|length %}
  <div class="space-y-4">
    {% for item in cart %}
        <div class="bg-white rounded-xl shadow p-4 flex items-center gap-4">
    {% with p=item.product %}

        {% if p.images.all %}
            <img src="{{ p.images.first.image.url }}" alt="{{ p.name }}" class="w-20 h-20 object-contain">
        {% endif %}
        <div class="flex-1">
            <a href="{% url 'core:product_detail' p.slug %}" class="font-semibold hover:underline">{{ p.name }}</a>
            <div class="text-sm text-gray-600">–¶–µ–Ω–∞: {{ item.price }} –≥—Ä–Ω</div>
        </div>
        {% if p.stock == 0 %}
            <div class="text-red-600 text-sm">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>
        {% endif %}
        <form action="{% url 'cart:add' p.id %}" method="post" class="flex items-center gap-2">
          {% csrf_token %}
          <input type="number"
                 name="quantity"
                 min="1"
                 max="{{ p.stock }}"
                 value="{{ item.quantity }}"
                 class="w-24 border rounded px-3 py-2">
          <input type="hidden" name="override" value="True">
          <button class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>

        <div class="text-xs text-gray-500">–í –Ω–∞–ª–∏—á–∏–∏: {{ p.stock }}</div>
        <div class="w-32 text-right font-semibold">{{ item.total_price }} –≥—Ä–Ω</div>

        <form action="{% url 'cart:remove' p.id %}" method="post">
            {% csrf_token %}
            <button class="px-3 py-2 rounded bg-red-50 text-red-700 hover:bg-red-100">–£–¥–∞–ª–∏—Ç—å</button>
        </form>
{% endwith %}
  </div>
    {% endfor %}
  </div>

  <div class="mt-6 flex items-center justify-between">
    <form action="{% url 'cart:clear' %}" method="post">
      {% csrf_token %}
      <button class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </form>

    <div class="text-xl">
      –ò—Ç–æ–≥–æ: <span class="font-bold">{{ cart.get_total_price }} –≥—Ä–Ω</span>
    </div>
  </div>
    <!-- üöö –ë–ª–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ Nova Poshta -->
<h3 class="text-2xl font-semibold mt-8 mb-4">–î–æ—Å—Ç–∞–≤–∫–∞</h3>
<div id="delivery" class="bg-gray-50 p-4 rounded-lg shadow-sm">
  <label class="block text-sm font-medium text-gray-700 mb-2">–ì–æ—Ä–æ–¥:</label>
  <input type="text" id="city" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥"
         class="w-full border rounded px-3 py-2 mb-3 focus:ring focus:ring-blue-200">

  <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–µ–Ω–∏–µ:</label>
  <select id="warehouse"
          class="w-full border rounded px-3 py-2 focus:ring focus:ring-blue-200">
      <option>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
  </select>
</div>

<script>
document.getElementById('city').addEventListener('input', async (e) => {
    const q = e.target.value.trim();
    if (q.length < 2) return;  // –Ω–µ –∏—Å–∫–∞—Ç—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã

    const res = await fetch(`/delivery/cities/?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    // –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    const select = document.getElementById('warehouse');
    select.innerHTML = '<option>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ</option>';

    if (data.length === 0) {
        select.innerHTML = '<option>–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</option>';
        return;
    }

    // –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    data.forEach(city => {
        const opt = document.createElement('option');
        opt.value = city.Ref;
        opt.textContent = city.Description;
        select.appendChild(opt);
    });

    // –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥–æ—Ä–æ–¥–∞ ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª–µ–Ω–∏—è
    select.addEventListener('change', async () => {
        const cityRef = select.value;
        const res2 = await fetch(`/delivery/warehouses/?ref=${cityRef}`);
        const data2 = await res2.json();
        select.innerHTML = '';
        data2.forEach(w => {
            const opt2 = document.createElement('option');
            opt2.textContent = w.Description;
            opt2.value = w.Ref;
            select.appendChild(opt2);
        });
    });
});
</script>
<!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->

    <div class="mt-4 text-right">
      {% if user.is_authenticated %}
        <a href="#"
           class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
      {% else %}
        <button class="px-4 py-2 rounded bg-gray-300 text-gray-600 cursor-not-allowed">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <p class="mt-2 text-sm text-red-600">–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            <a href="{% url 'accounts:login' %}" class="underline">–≤–æ–π—Ç–∏</a>
            –∏–ª–∏
            <a href="{% url 'accounts:signup' %}" class="underline">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>.
        </p>
      {% endif %}
    </div>
{% else %}
  <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
{% endif %}
{% endblock %}
